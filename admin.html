<!DOCTYPE html>
<html lang="si">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Panel - Edit GitHub Files</title>
  <style>
    :root { --bg:#001222; --card:#022a3a; --accent:#00bfff; --text:#eef8ff; }
    body { font-family: "Segoe UI", Roboto, sans-serif; background: linear-gradient(180deg,#000814,#001f3f); color:var(--text); margin:0; min-height:100vh; padding:28px; }
    .wrap { max-width:1100px; margin:0 auto; }
    .card { background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:12px; padding:18px; box-shadow:0 8px 30px rgba(0,0,0,0.6); border:1px solid rgba(0,191,255,0.06); }
    h1 { color:var(--accent); margin:0 0 12px 0; }
    label { display:block; font-size:0.95rem; margin:10px 0 6px; color:#dff7ff; }
    input[type=text], input[type=password], select, textarea {
      width:100%; padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:rgba(255,255,255,0.02); color:var(--text);
      box-sizing:border-box; font-size:0.95rem;
    }
    textarea { min-height:320px; font-family: monospace; white-space:pre-wrap; }
    .row { display:flex; gap:12px; align-items:center; }
    .row .col { flex:1; }
    button {
      background:var(--accent); color:#001a23; border:none; padding:10px 16px; border-radius:8px; cursor:pointer; font-weight:600;
    }
    button.ghost { background:transparent; color:var(--text); border:1px solid rgba(255,255,255,0.06); }
    .small { font-size:0.85rem; color:#bfefff; margin-top:8px; }
    .status { margin-top:12px; padding:10px 12px; border-radius:8px; background:rgba(0,0,0,0.25); color:#cfeffd; }
    .danger { color:#ffb3b3; }
    footer { margin-top:18px; font-size:0.85rem; color:#9fdfff; opacity:0.9; }
    .preview { border-radius:8px; border:1px solid rgba(255,255,255,0.04); overflow:hidden; margin-top:12px; }
    iframe { width:100%; height:400px; border:0; display:block; }
    @media (max-width:800px) { .row { flex-direction:column; } }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>üîß Simple GitHub-backed Admin</h1>
      <p class="small">‡∂î‡∂∂‡∑ö GitHub repo ‡∂ë‡∂ö‡∑ö HTML files (static site) ‡∑Ä‡∑í‡∑Ä‡∂ª‡∑ä‡∂≠‡∂±‡∂∫/‡∑É‡∂Ç‡∑É‡∑ä‡∂ö‡∂ª‡∂´‡∂∫ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±. <strong>Security:</strong> Do not expose your token publicly.</p>

      <!-- LOGIN / CONFIG -->
      <label>GitHub Username</label>
      <input id="ghUser" type="text" placeholder="e.g. nipuwa" />

      <label>Repository name</label>
      <input id="ghRepo" type="text" placeholder="e.g. Nipunbet" />

      <label>Branch</label>
      <input id="ghBranch" type="text" placeholder="e.g. main" value="main" />

      <label>Personal Access Token (PAT)</label>
      <input id="ghToken" type="password" placeholder="Paste a GitHub token with repo scope (or use server proxy)" />

      <div style="display:flex; gap:8px; margin-top:12px;">
        <button id="btnConnect">üîó Connect</button>
        <button class="ghost" id="btnDisconnect">‚õî Disconnect</button>
      </div>

      <div id="connectStatus" class="status" style="display:none;"></div>

      <hr style="margin:16px 0; border:none; height:1px; background:rgba(255,255,255,0.03);" />

      <!-- FILE SELECT / LOAD -->
      <label>Choose file to edit</label>
      <div class="row">
        <div class="col">
          <select id="fileSelect">
            <option value="about.html">about.html</option>
            <option value="index.html">index.html</option>
            <option value="Bank_Details.html">Bank_Details.html</option>
            <option value="promo.html">promo.html</option>
            <option value="Proofs.html">Proofs.html</option>
            <!-- add more file names here as needed -->
          </select>
        </div>
        <div style="width:150px">
          <button id="btnLoad" class="">üì• Load</button>
        </div>
      </div>

      <label style="margin-top:12px;">File content (Edit below)</label>
      <textarea id="fileContent" placeholder="Loaded file content will appear here..."></textarea>

      <div style="display:flex; gap:8px; margin-top:8px;">
        <button id="btnSave">üíæ Save to GitHub</button>
        <button id="btnPreview" class="ghost">üîç Preview</button>
        <button id="btnRevert" class="ghost">‚ôªÔ∏è Revert (reload)</button>
      </div>

      <div id="opStatus" class="status" style="display:none;"></div>

      <div class="preview" id="previewWrap" style="display:none;">
        <iframe id="previewFrame"></iframe>
      </div>

      <footer>
        <div>Security note: For production use, implement server-side proxy to keep tokens secret. This client-side approach is for quick admin use only.</div>
      </footer>
    </div>
  </div>

<script>
/* -------------------------
  Helper utilities
   - base64 encode/decode for utf-8 safe strings
----------------------------*/
function utoa(str) { return btoa(unescape(encodeURIComponent(str))); }
function atou(b64) { return decodeURIComponent(escape(atob(b64))); }

/* -------------------------
  GitHub file helpers
----------------------------*/
async function ghGetFile(user, repo, branch, path, token) {
  const url = `https://api.github.com/repos/${user}/${repo}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(branch)}`;
  const res = await fetch(url, {
    headers: { Authorization: `token ${token}`, Accept: 'application/vnd.github+json' }
  });
  if (!res.ok) {
    const txt = await res.text();
    throw new Error(`GitHub GET failed: ${res.status} ${txt}`);
  }
  const json = await res.json();
  return json; // contains content (base64) and sha
}

async function ghUpdateFile(user, repo, branch, path, contentStr, sha, token, message) {
  const url = `https://api.github.com/repos/${user}/${repo}/contents/${encodeURIComponent(path)}`;
  const body = {
    message: message || `Update ${path} via admin panel`,
    content: utoa(contentStr),
    branch: branch,
    sha: sha
  };
  const res = await fetch(url, {
    method: 'PUT',
    headers: { Authorization: `token ${token}`, Accept: 'application/vnd.github+json', 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  });
  if (!res.ok) {
    const txt = await res.text();
    throw new Error(`GitHub PUT failed: ${res.status} ${txt}`);
  }
  return await res.json();
}

/* -------------------------
  DOM & events
----------------------------*/
const ghUser = document.getElementById('ghUser');
const ghRepo = document.getElementById('ghRepo');
const ghBranch = document.getElementById('ghBranch');
const ghToken = document.getElementById('ghToken');
const btnConnect = document.getElementById('btnConnect');
const btnDisconnect = document.getElementById('btnDisconnect');
const connectStatus = document.getElementById('connectStatus');

const fileSelect = document.getElementById('fileSelect');
const btnLoad = document.getElementById('btnLoad');
const fileContent = document.getElementById('fileContent');
const btnSave = document.getElementById('btnSave');
const opStatus = document.getElementById('opStatus');
const btnPreview = document.getElementById('btnPreview');
const previewWrap = document.getElementById('previewWrap');
const previewFrame = document.getElementById('previewFrame');
const btnRevert = document.getElementById('btnRevert');

let currentFileSha = null;
let connected = false;

function showStatus(el, text, danger=false) {
  el.style.display = 'block';
  el.textContent = text;
  el.classList.toggle('danger', danger);
}
function hideStatus(el) { el.style.display = 'none'; }

btnConnect.addEventListener('click', async () => {
  const user = ghUser.value.trim();
  const repo = ghRepo.value.trim();
  const branch = ghBranch.value.trim() || 'main';
  const token = ghToken.value.trim();
  if (!user || !repo || !token) {
    showStatus(connectStatus, 'Provide GitHub username, repo and token first.', true);
    return;
  }
  showStatus(connectStatus, 'Connecting to GitHub...', false);
  try {
    // quick test: get repo
    const testRes = await fetch(`https://api.github.com/repos/${user}/${repo}`, {
      headers: { Authorization:`token ${token}`, Accept:'application/vnd.github+json' }
    });
    if (!testRes.ok) {
      throw new Error(`Repo access failed: ${testRes.status}`);
    }
    const repoJson = await testRes.json();
    showStatus(connectStatus, `Connected ‚úÖ ‚Äî Repo: ${repoJson.full_name} (default branch: ${repoJson.default_branch})`);
    connected = true;
    // optionally set branch to repo default if empty
    if (!ghBranch.value) ghBranch.value = repoJson.default_branch || branch;
  } catch (err) {
    showStatus(connectStatus, `Connection error: ${err.message}`, true);
    console.error(err);
    connected = false;
  }
});

btnDisconnect.addEventListener('click', () => {
  ghToken.value = '';
  connected = false;
  showStatus(connectStatus, 'Disconnected. Token cleared.');
});

/* Load file */
btnLoad.addEventListener('click', async () => {
  if (!connected) {
    showStatus(opStatus, 'Not connected. Click Connect and ensure token is valid.', true);
    return;
  }
  const user = ghUser.value.trim(), repo = ghRepo.value.trim(), branch = ghBranch.value.trim(), token = ghToken.value.trim();
  const path = fileSelect.value;
  showStatus(opStatus, `Loading ${path}...`);
  try {
    const json = await ghGetFile(user, repo, branch, path, token);
    const content = json.content ? atou(json.content.replace(/\n/g,'')) : '';
    fileContent.value = content;
    currentFileSha = json.sha;
    showStatus(opStatus, `Loaded ${path} (sha: ${currentFileSha}). You can edit and Save.`);
    previewWrap.style.display = 'none';
  } catch (err) {
    showStatus(opStatus, `Load failed: ${err.message}`, true);
    console.error(err);
  }
});

/* Save file */
btnSave.addEventListener('click', async () => {
  if (!connected) {
    showStatus(opStatus, 'Not connected. Click Connect first.', true);
    return;
  }
  const user = ghUser.value.trim(), repo = ghRepo.value.trim(), branch = ghBranch.value.trim(), token = ghToken.value.trim();
  const path = fileSelect.value;
  const newContent = fileContent.value;
  if (!currentFileSha) {
    showStatus(opStatus, 'No file loaded (sha missing). Click Load first.', true);
    return;
  }
  showStatus(opStatus, `Saving ${path}...`);
  try {
    const res = await ghUpdateFile(user, repo, branch, path, newContent, currentFileSha, token, `Update ${path} via admin panel`);
    currentFileSha = res.content.sha; // update sha
    showStatus(opStatus, `Saved successfully ‚úÖ (new sha: ${currentFileSha})`);
  } catch (err) {
    showStatus(opStatus, `Save failed: ${err.message}`, true);
    console.error(err);
  }
});

/* Preview (renders edited content as data URL) */
btnPreview.addEventListener('click', () => {
  const html = fileContent.value;
  const blob = new Blob([html], { type: 'text/html' });
  const url = URL.createObjectURL(blob);
  previewFrame.src = url;
  previewWrap.style.display = 'block';
});

/* Revert reload from GitHub */
btnRevert.addEventListener('click', async () => {
  btnLoad.click();
});

</script>
</body>
</html>
